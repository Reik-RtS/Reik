<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de Monedas</title>
</head>
<body>
    <pre id="output"></pre>

    <script>
        const currencies = ['USD', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'CNY', 'HKD', 'NZD', 'SEK', 'KRW', 'SGD', 'NOK', 'MXN', 'INR', 'RUB', 'ZAR', 'TRY', 'BRL', 'PEN', 'CLP', 'COP', 'ARS', 'VEF', 'PEN'];

        async function fetchRates() {
            const response = await fetch('https://open.er-api.com/v6/latest/USD');
            if (!response.ok) {
                throw new Error('Error al obtener tasas de cambio');
            }
            const data = await response.json();
            return data.rates;
        }

        async function fetchCountryData(currencyCode) {
            const url = `https://restcountries.com/v3.1/currency/${currencyCode}?fields=name,flags,currencies`;
            const response = await fetch(url);
            if (!response.ok) {
                console.warn(`Sin datos para ${currencyCode}`);
                return null;
            }
            const countries = await response.json();
            return countries.length > 0 ? countries[0] : null;
        }

        async function build() {
            try {
                const rates = await fetchRates();
                const list = [];

                for (const code of currencies) {
                    const rate = rates[code];
                    if (rate === undefined) {
                        console.warn(`Tasa no disponible para ${code}`);
                        continue;
                    }

                    const countryData = await fetchCountryData(code);
                    if (!countryData) continue;

                    const flagUrl = countryData.flags.png || countryData.flags.svg || '';
                    const nameFlag = countryData.name.common || '';
                    let symbol = '';

                    if (countryData.currencies) {
                        const currencyInfo = Object.values(countryData.currencies).find(c => c);
                        if (currencyInfo && currencyInfo.symbol) {
                            symbol = currencyInfo.symbol;
                        }
                    }

                    list.push({
                        codigo: code,
                        bandera: flagUrl,
                        pais: nameFlag,
                        simbolo: symbol,
                        tasa: rate
                    });
                }

                list.sort((a, b) => a.codigo.localeCompare(b.codigo));

                document.getElementById('output').textContent = JSON.stringify(list, null, 2);

                // Notificar a Android que los datos est√°n listos
                if (window.androidHandler) {
                    window.androidHandler.onDataReady();
                }

            } catch (error) {
                document.getElementById('output').textContent = 'Hubo un error: ' + error.message;

                if (window.androidHandler) {
                    window.androidHandler.onDataReady();
                }
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', build);
        } else {
            build();
        }
    </script>
</body>
</html>